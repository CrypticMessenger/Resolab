graph TD
    classDef client fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef server fill:#f3e5f5,stroke:#4a148c,stroke-width:2px;
    classDef external fill:#fff3e0,stroke:#e65100,stroke-width:2px,stroke-dasharray: 5 5;
    classDef db fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px;

    %% --- Client Side (Browser) ---
    subgraph Client ["Client (Browser/Next.js Client)"]
        direction TB
        UI("SpatialAudioEditor (React 19)"):::client
        Three("Three.js Canvas (R3F)"):::client
        AudioCtx("Web Audio Context\n(Gain, Panner, Convolver)"):::client
        IDB[("IndexedDB\nLocal Cache")]:::db
        
        UI --> Three
        UI --> AudioCtx
        AudioCtx -.-> IDB
    end

    %% --- Server Side (Next.js Actions & Routes) ---
    subgraph Server ["Server (Next.js App Router)"]
        direction TB
        AutoFoley("Auto-Foley Agent\n(analyzeVideoAction)"):::server
        Director("AI Director Agent\n(generateSceneAction)"):::server
        AssetLib("Asset Matcher Library"):::server
        
        UI -- "1. Invoke Action" --> AutoFoley
        UI -- "Prompt" --> Director
        AutoFoley --> AssetLib
    end

    %% --- External Services ---
    subgraph Services ["External Cloud Services"]
        direction TB
        Supabase[("Supabase\n(Storage & DB)")]:::external
        GFile("Google AI\nFile Manager"):::external
        Gemini{{"Google Gemini 3\n(Flash/Pro)"}}:::external

        UI -- "Direct Upload (Video)" --> Supabase
        AutoFoley -- "Download Stream" --> Supabase
        AutoFoley -- "Upload & Poll" --> GFile
        GFile -- "Content Stream" --> Gemini
        Gemini -- "Scene Graph JSON" --> AutoFoley
        Director --> Gemini
    end

    %% --- Data Flow ---
    Supabase -.->|"Fetch Audio Assets"| IDB
    AssetLib -.->|"Asset URLs"| AutoFoley
