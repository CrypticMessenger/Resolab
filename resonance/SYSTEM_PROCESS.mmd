stateDiagram-v2
    direction LR

    %% --- User Input ---
    [*] --> Idle
    Idle --> Uploading : Drag & Drop Video
    Idle --> Thinking : Type Prompt

    %% --- Client Side Logic ---
    state Uploading {
        [*] --> CheckSize : > 50MB? (Error)
        CheckSize --> DirectUpload : Supabase Storage
        DirectUpload --> [*] : Returns URL
    }

    Uploading --> Analysis : URL Ready

    %% --- Server Side Logic (AI) ---
    state Analysis {
        [*] --> Downloading : Supabase -> Server
        Downloading --> GFileManager : Upload to Google AI
        GFileManager --> GeminiThinking : Generate Content
        GeminiThinking --> JSON : Scene Graph Result
        JSON --> Cleanup : Delete Temp Files
        Cleanup --> AssetMatching : Map Tags to URLs
    }

    Analysis --> Hydrating : Return Scene Graph

    %% --- Client Side Logic (Hydration) ---
    state Hydrating {
        [*] --> CheckCache : IndexedDB Lookup
        CheckCache --> FetchAudio : Cache Miss
        FetchAudio --> SaveToCache : Network Request
        SaveToCache --> BufferReady : Cache Hit
        CheckCache --> BufferReady : Instant Load
        BufferReady --> ThreeJS : Initialize Objects
        ThreeJS --> WebAudio : Sync Nodes
    }

    Hydrating --> Interactive : Scene Ready ðŸŽµ

    state Interactive {
        [*] --> IdleState
        IdleState --> Playing : Play Button
        Playing --> IdleState : Pause
        IdleState --> Exporting : Click Export
        Exporting --> IdleState : Download Complete
    }

    Interactive --> [*]
